<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/global.css" />
		<link rel="stylesheet" href="../../css/style3.css" />
		<link rel="stylesheet" href="../../css/mui.picker.min.css" />
		<style type="text/css">
			html,
			body {
				height: 100%;
				width: 100%;
			}
			
			.mui-content {
				height: 99%;
			}
			
			.form-title {
				position: fixed;
				z-index: 999;
				width: 100%;
				background: white;
			}
			
			.form-item {
				display: flex;
				margin: 1rem;
			}
			
			.item-flex {
				flex: 1;
			}
			
			.label-end {
				text-align: center;
			}
			
			.label-input-gray {
				border: solid 1px !important;
				background: #efeff4 !important;
				border-color: #999 !important;
				padding-left: 1rem !important;
				color: gray;
			}
			
			.label-input-arrow {
				border: solid 1px !important;
				background: #efeff4 !important;
				border-color: #999 !important;
				padding-left: 1rem !important;
				background: url(../../images/arrow.png) right center no-repeat !important;
			}
			
			.wrapper-padding {
				padding-top: 16vh;
				height: 95%;
			}
			
			.md-form-title {
				display: flex;
				width: 100%;
				text-align: center;
				padding-top: 10.5vh;
				position: fixed;
				z-index: 700;
				padding-right: 2.3vh;
				background-color: #ddd;
			}
			
			.icon-color-font-size {
				font-size: 2vh;
				color: gray;
			}
			
			.md-check-div {
				display: flex;
				text-align: center;
			}
			
			.md-first-item {
				/*margin-top: 10%;
				text-align: left;*/
				position: relative;
				top: 50%;
				/*left: 0;*/
				margin-left: -1vh;
				transform: translate(0%, 50%);
			}
			
			.md-div-right {
				flex: 8;
				text-align: left;
			}
			
			.md-save-btn {
				position: relative;
				z-index: 20;
				margin-top: 1.5vh;
				padding-bottom: 10px;
			}
			
			#nokPopover {
				position: absolute;
				z-index: 1001;
				left: 5%;
				top: 5%;
				width: 90%;
				height: 90%;
			}
			
			.mui-table-view:before {
				position: absolute;
				right: 0;
				left: 0;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: transparent;
				top: -1px;
			}
			
			.mui-table-view:after {
				position: absolute;
				right: 0;
				bottom: 0;
				left: 0;
				height: 1px;
				content: '';
				-webkit-transform: scaleY(.5);
				transform: scaleY(.5);
				background-color: transparent;
			}
			
			.md-detail-btn {
				margin-right: 1vh;
			}
			
			.md-background-btn {
				background-color: #1377e3;
				color: #f7f7f7;
			}
			
			.md-footer {
				width: 100%;
				color: white;
				font-size: 1.5vh;
				font-weight: 600;
				background-color: transparent;
				border: transparent;
			}
			
			.mui-backdrop {
				position: fixed;
				z-index: 1000;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				background-color: rgba(0, 0, 0, .3);
			}
			
			.md-close-div {
				display: flex;
				text-align: right;
			}
			
			.md-close-popover {
				font-size: 3vh;
				color: #007aff;
				right: 0px;
				width: 100%;
			}
			
			.md-check-ok {
				color: #34db34;
			}
			
			.md-check-nok {
				color: red;
			}
			
			.md-item-lineheight {
				line-height: 2vh;
			}
			
			.md-check-cok {
				color: red;
			}
			
			.md-check-na {
				color: black;
			}
			.md-required{
				color: red;
			}
			.md-title-icon{
				font-size: 2vh;
				font-weight: 600;
			}
			.md-title-figure{
				font-size: 2.5vh;
				font-weight: 600;
			}
		</style>
	</head>

	<body>
		<div class="mui-content" id="pollingNew">
			<header class="mui-bar mui-bar-nav">
				<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left md-title-icon"></a>
				<h1 class="mui-title md-title-figure" id="title" >检查清单</h1>
			</header>
			<div class="mui-content content-background" style="">
				<div class="form-title">
					<div style="" class="form-item">
						<div class="mui-input-row item-flex">
							<label class="label-end md-required">清单名称:</label>
							<select style="" class="label-input-arrow md-input-height" :disabled="isSelect" v-model="plist1" @change="chooseLine(plist1)">
								<option v-for="plist in plines" v-bind:value="plist.listSubId">
									{{ plist.listName }}
								</option>
							</select>
						</div>
						<div class="mui-input-row item-flex">
							<label class="label-end md-required">班次:</label>
							<select style="" class="label-input-arrow md-input-height" v-model="classes">
								<option v-for="option in options" v-bind:value="option.value">
									{{ option.text }}
								</option>
							</select>
						</div>
					</div>
					<div class="form-item">
						<div class="mui-input-row item-flex">
							<label class="label-end">生产线:</label>
							<input class="label-input-gray" readonly type="text" v-model="productionLine">
						</div>
						<div class="mui-input-row item-flex">
							<label class="label-end md-required">检查日期</label>
							<input class="label-input-gray" style="background: url(../../images/arrow.png) right center no-repeat !important;" readonly id="checkTime" v-model="checkTime" type="text">
						</div>
					</div>
				</div>
				<div class="mui-content">
					<div class="md-form-title" style="">
						<div class="mui-input-row item-flex">
							检查序号
						</div>
						<div class="mui-input-row item-flex">
							工位名称
						</div>
						<div style="flex: 8;display: flex;">
							<div class="mui-input-row" style="flex: 5;">
								检查项目清单
							</div>
							<!--<div class="mui-input-row item-flex">
								读数
							</div>-->
							<div class="mui-input-row item-flex">
								状态
							</div>
							<div class="mui-input-row item-flex">
								Y
							</div>
							<div class="mui-input-row item-flex">
								N
							</div>
							<div class="mui-input-row item-flex">
								C
							</div>
							<div class="mui-input-row item-flex">
								NA
							</div>
						</div>
					</div>
					<div id="scroll" class="mui-scroll-wrapper wrapper-padding">
						<div class="mui-scroll">
							<ul class="mui-table-view">
								<li class="mui-table-view-cell" v-for="(listData,index) in listDatas" v-bind:key="listData.id">
									<div class="md-check-div">
										<div class="item-flex md-first-item" v-text="listData.checkNo"></div>
										<div class="item-flex md-first-item" v-text="listData.name"></div>
										<div class="md-div-right ">
											<ul class="mui-table-view">
												<li class="mui-table-view-cell md-check-div md-item-lineheight" v-for="(detailData,index2) in listData.data">
													<div style="flex: 5;text-align: left;" v-text="detailData.checkList"></div>
													<div class="item-flex" style="font-weight: 600;" :class="{'md-check-ok':detailData.statusForExcel == '符合','md-check-ok':detailData.statusForExcel == '符合','md-check-nok':detailData.statusForExcel == '当即整改' || detailData.statusForExcel == '不符处理','md-check-cok':detailData.statusForExcel == '立即纠正','md-check-na':detailData.statusForExcel == 'NA'}" v-text="detailData.statusForExcel"></div>
													<div class="item-flex"><span class="icon-uniF192 icon-color-font-size" :class="{'md-check-ok':detailData.statusForExcel == '符合'}" @tap="onTapOk(detailData,index2)"></span></div>
													<div class="item-flex" @tap="onTapNok(detailData,index2)"><span class="icon-uniF057 icon-color-font-size" :class="{'md-check-nok':detailData.statusForExcel == '当即整改' || detailData.statusForExcel == '不符处理'}"></span></div>
													<div class="item-flex" @tap="onTapCurrent(detailData,index2)"><span class="icon-uniF05E icon-color-font-size" :class="{'md-check-cok':detailData.statusForExcel == '立即纠正'}"></span></div>
													<div class="item-flex" @tap="onTapNA(detailData,index2)"><span class="icon-NA icon-color-font-size" :class="{'md-check-na':detailData.statusForExcel == 'NA'}"></span></div>
												</li>
											</ul>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</div>

				</div>
				<div class="mui-card-footer" style="background-color: #0d5796;text-align: center;display: flex;position: fixed;bottom: 0px;width: 100%;">
					<!--<button type="button" class="md-footer md-keyi" @tap="onTapSave">提交</button>-->
					<button type="button" id="save" class="md-footer md-keyi" v-bind:disabled="disabled" data-loading-text="提交中" data-loading-icon-position="right" @tap="onTapSave">确认</button>
				</div>
			</div>

			<div id="nokPopover" class="mui-popover">
				<div class="md-close-div" @tap="onTapClosePopover"><span class="icon-uniF057 md-close-popover"></span></div>
				<div class="mui-content" style="display: flex;height: 100%;">
					<div class="mui-content" id="refreshData" style="flex:9;height: 100%;">
						<div>
							<div class="form-item">
								<div class="mui-input-row item-flex">
									<label class="label-end">检查序号:</label>
									<input class="label-input-gray" readonly v-model="itemData.checkNo" type="text">
								</div>
								<div class="mui-input-row item-flex">
									<label class="label-end">工位名称:</label>
									<input class="label-input-gray" readonly v-model="itemData.stationName" type="text">
								</div>
							</div>
							<label style="margin-left: 1rem;">问题描述:</label>
							<textarea id="remark" rows="5" style="margin-top: .5rem;" placeholder="描述" v-model="itemData.description"></textarea>
							<div>
								<ul class="mui-table-view" style="margin: .5rem;color: black;">
									<li class="mui-table-view-cell mui-media mui-collapse mui-active" id="lpaList">
										<a class="mui-navigate-right" href="#">一般数据处理(<span style="color:red">当即整改,非质量问题处理</span>)</a>
										<div class="mui-collapse-content">
											<label style="margin-left: 1rem;">抑制措施:</label>
											<textarea id="remark" rows="5" style="margin-top: .5rem;" v-model="itemData.measure"></textarea>
											<div style="display: flex;">
												<button type="button" class="md-detail-btn md-background-btn" @tap="onTapPcorrected(itemData)">当即整改</button>
												<button type="button" class="md-detail-btn md-background-btn" @tap="onTapUpQuestion(itemData)">上升问题流</button>
												<button type="button" class="md-background-btn" @tap="upOneLevel">返回</button>
											</div>
										</div>
									</li>
									<li class="mui-table-view-cell mui-media mui-collapse" id="lpaList">
										<a class="mui-navigate-right" href="#">不合格品数据处理(<span style="color:red">有不合格数时必填</span>)</a>
										<div class="mui-collapse-content">
											<div style="display: flex;">
												<div style="flex: 1;">
													<div class="mui-input-row ">
														<label class="label-end">不合格数:</label>
														<input class="label-input-gray" type="number" v-model="itemData.actualDisqualified">
													</div>
												</div>
												<div style="flex: 1;">
													<div class="mui-input-row ">
														<label class="label-end" style="width: 40% !important;">问题分类:</label>
														<!--<input class="label-input-gray" readonly type="text" >-->
														<select style="width: 60% !important;" class="label-input-arrow md-input-height" v-model="itemData.upProblemType">
															<option v-for="question in questions" v-bind:value="question.text">
																{{ question.text }}
															</option>
														</select>
													</div>
												</div>

											</div>
											<div>
												<form class="mui-input-group" style="display: flex;">
													<div style="margin-top: .5vh;">缺陷类别:</div>
													<div class="mui-input-row mui-radio mui-left">
														<label>原材料缺陷</label>
														<input name="isDefect" value="1" type="radio" v-model="itemData.isolation">
													</div>
													<div class="mui-input-row mui-radio mui-left">
														<label>产品缺陷</label>
														<input name="isDefect" value="0" type="radio" v-model="itemData.isolation">
													</div>
												</form>
											</div>
											<div style="display: flex;margin-top: 1vh;">
												<button type="button" class="md-detail-btn md-background-btn" @tap="onTapDisqualified(itemData)">不合格品处理</button>
												<button type="button" class="md-background-btn">返回</button>
											</div>
										</div>
									</li>
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/mui.picker.min.js"></script>
		<script type="text/javascript" src="../../config.js"></script>
		<script type="text/javascript" src="../../js/static.js"></script>
		<script type="text/javascript" src="../../js/function.js"></script>
		<script type="text/javascript" src="../../js/utils.js"></script>
		<script type="text/javascript" src="../../js/vue.min.js"></script>
		<script type="text/javascript">
			new Vue({
				el: '#pollingNew',
				data: {
					classes: '',
					classes2: '',
					plist1: '',
					listName: '',
					selectTime: '',
					plines: [],
					lineName: '',
					productionLine: '',
					checkTime: '', //检查日期
					disabled: true,
					isSelect: true,
					pollingItem: {},
					originalData: [],
					itemData: {},
					subId: -1,
					options: [{
							text: '早班',
							value: '早班'
						},
						{
							text: '晚班',
							value: '晚班'
						}
					],
					questions: [{
							text: '人',
							value: '人'
						},
						{
							text: '机',
							value: '机'
						},
						{
							text: '料',
							value: '料'
						},
						{
							text: '法',
							value: '法'
						}, {
							text: '环',
							value: '环'
						},
						{
							text: '其他',
							value: '其他'
						}
					],
					listDatas: []
				},
				created: function() {
					this.plist1 = JSON.parse(getLsItem("pollingItem")).listSubId;
				},
				mounted: function() {
					mui.init({
						beforeback: function() {　　　　 //获得父页面的webview
							var list = plus.webview.currentWebview().opener();　　　　 //触发父页面的自定义事件(refresh),从而进行刷新
							mui.fire(list, 'refreshData');
							//返回true,继续页面关闭逻辑
							return true;
						}
					});
					mui('.mui-scroll-wrapper').scroll({
						indicators: true //是否显示滚动条
					});
					var _this = this;
					_this.disabled = !_this.disabled;
					//console.log(JSON.parse(getLsItem("selectDate")));
					var _pollingItem = JSON.parse(getLsItem("pollingItem"));
					if(_pollingItem.temp == '') {
						_this.isSelect = !_this.isSelect;
					} else {
						_this.classes = _pollingItem.shift;
						_this.subId = _pollingItem.subId;
						_this.checkTime = _pollingItem.checkTime;
						_this.productionLine = _pollingItem.productionLine;
						_this.listName = _pollingItem.listName;
						mAjax(_url + "learServer/getInspectListItemDetails", {
							subId: _pollingItem.subId,
							workDate: FormatDateYMD(_pollingItem.inspectDate)
						}, function(data) {
							if(data.success == 1) {
								_this.originalData = data;
								//console.log(_this.originalData );
								_this.$nextTick(function() {
									// DOM 更新了
									_this.formatData(data);
								})

							}
						})
					}
					mAjax(_url + "learServer/getInspectListInfo", {}, function(data) {
						if(data.success == 1) {
							_this.plines = data.data;
						}
					})
					this.initData();
				},
				methods: {
					//初始化数据
					initData: function() {
						var _this = this;
						selectDate('time', 'checkTime', '', function(data) {
							_this.checkTime = data.text;
						});
					},
					formatData: function(data) {
						for(var m = 0; m < data.data.length; m++) {
							if(data.data[m].solveMethod == 'c') {
								data.data[m].statusForExcel = "立即纠正";
							}
							if(data.data[m].solveMethod == "quickSolve") {
								data.data[m].statusForExcel = "当即整改";
							}
							if(data.data[m].solveMethod == "action") {
								data.data[m].statusForExcel = "不符处理";
							}
							if(data.data[m].solveMethod == "na") {
								data.data[m].statusForExcel = "NA";
							}
						}
						var _this = this;
						var json = {};
						var res = [];
						for(var i = 0; i < data.data.length; i++) {
							if(!json[data.data[i].stationName]) {
								res.push({
									name: data.data[i].stationName,
									checkNo: data.data[i].checkNo
								});
								json[data.data[i].stationName] = 1;
							}
						}
						for(var k = 0; k < res.length; k++) {
							var _arr2 = [];
							for(var i = 0; i < data.data.length; i++) {
								if(data.data[i].stationName == res[k].name) {
									_arr2.push(data.data[i]);
									res[k].data = _arr2;
								}
							}
						}
						_this.listDatas = res;
						//console.log(res);
					},
					//ok
					onTapOk: function(item, index) {
						item.auditResult = "ok";
						item.solveMethod = "";
						item.checkImg = "";
						item.description = "";
						item.measure = "";
						item.statusForExcel = "符合";
					},
					//NA
					onTapNA: function(item, index) {
						/*item.statusForExcel = "NA";
						item.solveMethod = "na";*/
						item.auditResult = "na";
						item.solveMethod = "na";
						item.checkImg = "";
						item.description = "";
						item.measure = "";
						item.statusForExcel = "NA";
					},
					//立即纠正
					onTapCurrent: function(item, index) {
						item.auditResult = "c";
						item.solveMethod = "c";
						item.checkImg = "";
						item.description = "";
						item.measure = "";
						item.statusForExcel = "立即纠正"
						/*item.solveMethod = "c";
						item.statusForExcel = "立即纠正"*/
					},
					//nok
					onTapNok: function(item, index) {
						this.itemData = item;
						//item.statusForExcel = "当即整改"
						mui('#nokPopover').popover('toggle');
					},
					//当即整改
					onTapPcorrected: function(item) {
						var _userData = JSON.parse(getLsItem("mopcData"));
						item.inspectorId = _userData.userNo;
						item.inspector = _userData.userDescription;
						item.auditResult = "nok";
						item.checkImg = "search";
						item.solveMethod = "quickSolve";
						item.statusForExcel = "当即整改";
						mui('#nokPopover').popover('toggle');
						//console.log(item);
					},
					//上升问题流
					onTapUpQuestion: function(item) {
						//console.log(item);
						mui('#nokPopover').popover('toggle');
					},
					//返回
					upOneLevel: function(item) {
						//若未保存 清空已填写的数据
						mui('#nokPopover').popover('toggle');
					},
					//不符合处理
					onTapDisqualified: function(item) {
						var _userData = JSON.parse(getLsItem("mopcData"));
						item.inspectorId = _userData.userNo;
						item.inspector = _userData.userDescription;
						item.auditResult = "nok";
						item.checkImg = "search";
						item.solveMethod = "action";
						item.isNC = "1";
						item.statusForExcel = "不符处理";
						mui('#nokPopover').popover('toggle');
					},
					//选择清单
					chooseLine: function(item) {
						var _this = this;
						var _list
						//console.log(item);
						for(var k = 0; k < _this.plines.length; k++) {
							if(item == _this.plines[k].listSubId) {
								_this.productionLine = _this.plines[k].productionLine;
								_this.listName = _this.plines[k].listName;
								break;
							}
						}
						var _workDate = JSON.parse(getLsItem("selectDate"));
						_this.$nextTick(function() {
							// DOM 更新了
							mAjax(_url + "learServer/getInspectListByLineId", {
								listSubId: item,
								workDate: _workDate
							}, function(data) {
								if(data.success == 1) {
									_this.originalData = data;
									/*for(var m = 0; m < data.data.length; m++) {
										if(data.data[m].solveMethod == 'c') {
											data.data[m].statusForExcel = "立即纠正";
										}
										if(data.data[m].solveMethod == "quickSolve") {
											data.data[m].statusForExcel = "当即整改";
										}
										if(data.data[m].solveMethod == "action") {
											data.data[m].statusForExcel = "不符处理";
										}
										if(data.data[m].solveMethod == "na") {
											data.data[m].statusForExcel = "NA";
										}
									}*/
									var json = {};
									var res = [];
									for(var i = 0; i < data.data.length; i++) {
										if(!json[data.data[i].stationName]) {
											res.push({
												name: data.data[i].stationName,
												checkNo: data.data[i].checkNo
											});
											json[data.data[i].stationName] = 1;
										}
									}
									for(var k = 0; k < res.length; k++) {
										var _arr2 = [];
										for(var i = 0; i < data.data.length; i++) {
											if(data.data[i].stationName == res[k].name) {
												//console.log(res[k])
												_arr2.push(data.data[i]);
												res[k].data = _arr2;
											}
										}
									}
									_this.listDatas = res;
									//console.log(res);
								}
							})
						})

					},
					//关闭nok popover
					onTapClosePopover: function() {
						//若未保存 清空已填写的数据
						mui('#nokPopover').popover('toggle');
					},
					//保存
					onTapSave: function() {
						var _this = this;
						if(_this.plist1 == '' || _this.plist1 == undefined){
							mui.toast("请选择清单！！！");
							return;
						}
						if(_this.classes == ''){
							mui.toast("请选择班次！！！");
							return;
						}
						if(_this.checkTime == ''){
							mui.toast("请选择检测日期！！！");
							return;
						}
						var _userData = JSON.parse(getLsItem("mopcData"));
						//检测日期
						var _inspectDate = JSON.parse(getLsItem("selectDate"));
						var _pollingItem = JSON.parse(getLsItem("pollingItem"));
						var _obj = {};
						_obj.listSubId = _this.plist1;
						_obj.listName = _this.listName;
						_obj.productionLine = _this.productionLine;
						_obj.auditor = _userData.userName;
						_obj.auditorName = _userData.userDescription;
						_obj.inspectDate = _inspectDate;
						_obj.checkTime = _this.checkTime;
						_obj.shift = _this.classes;
						var _formXml = toXmlForDataFilters([_obj]);
						var _storeXml = toXmlForDataFilters(this.originalData.data);
						var _createDate = _pollingItem.createDate == null ? FormatDateYMDHMS(new Date()) : _pollingItem.createDate;
						mAjax(_url + "learServer/saveTitle", {
							subId: _this.subId + '',
							tableName: 'T_PP_inspectStoreMaster',
							formXml: _formXml
						}, function(data) {
							if(data.success == 1) {
								mAjax(_url + "learServer/save", {
									masterSubId: data.data[0].subId,
									createDate: _createDate,
									storeXml: _storeXml
								}, function(storeData) {
									if(storeData.success == 1) {
										removeLsItem("pollingItem")
										mui.back();
										//console.log(storeData);
									}
								})
								//console.log(data.data);
							}
						})
						/*this.disabled = !this.disabled
						mui("#save").button('loading');
						setTimeout(function() {
							this.disabled = !this.disabled
							mui("#save").button('reset');
						}, 2000);
						console.log(this.lineName);*/
					}
				}
			})
		</script>
	</body>

</html>